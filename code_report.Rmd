---
title: "Progetto di Biostatistica"
author: "Simone Farallo 889719 & Michele Salvaterra 891109"
output:
  html_document:
    toc: yes
    fig_caption: yes
    theme: flatly
    css: styles.css
  pdf_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: sentence
---

# Abstract

Il nostro progetto ha come obiettivo l'analisi di un dataset riguardante dei pazienti anziani. La prima fase del progetto è stata dedicata alla pulizia dei dati e al loro processing, al fine di rendere il dataset utilizzabile per le successive fasi dell'analisi.

Successivamente, è stata eseguita un'analisi esplorativa dei dati (EDA), al fine di individuare eventuali tendenze o correlazioni tra le variabili del dataset. Questa fase ha permesso di acquisire una migliore comprensione delle caratteristiche dei pazienti anziani in oggetto e di individuare le variabili più significative.

Infine, è stata effettuata un'analisi di sopravvivenza, al fine di valutare la relazione tra le variabili del dataset e la sopravvivenza dei pazienti.

# Introduction

La nostra analisi riguarda un dataset di 64 osservazioni riguardanti pazienti anziani. Dopo aver effettuato la pulizia e il preprocessing dei dati, abbiamo eseguito un'analisi esplorativa per identificare le variabili più importanti per la salute degli anziani. In particolare, abbiamo individuato SOFA e CCscore come le variabili più rilevanti per l'analisi della sopravvivenza. Queste variabili sono state utilizzate per valutare il rischio di disfunzione di organi e la gravità della malattia nei pazienti anziani.

Il punteggio "SOFA"(Sequential Organ Failure Assessment) che è uno strumento utilizzato per valutare la gravità dell'insufficienza di uno o più organi in pazienti in terapia intensiva.
Esso viene utilizzato come strumento di valutazione per monitorare il miglioramento o il deterioramento della funzione dell'organo nel tempo.

Il CCscore, invece, è un indice di comorbidità utilizzato per valutare la presenza di altre malattie croniche o condizioni preesistenti in un paziente. Il punteggio CCscore viene utilizzato per valutare la gravità della malattia e il rischio di mortalità in pazienti critici.

L'EDA (Exploratory Data Analysis) è una fase fondamentale dell'analisi dei dati che prevede l'esplorazione del dataset per comprendere le caratteristiche e le relazioni tra le variabili, in questo specifico dataset l'EDA ha incluso:

Analisi univariata: esaminare ogni variabile singolarmente per capire la loro distribuzione, valori anomali e statistiche riassuntive.

Analisi bivariata: esaminare la relazione tra le diverse coppie di variabili per capire se esiste una correlazione o associazione tra di esse, abbiamo esaminato la relazione tra SOFA e CC-score, tra età e BMI e tra anno e MMSE-score.

Analisi di sopravvivenza: in questo caso, l'EDA include la creazione di grafici di Kaplan-Meier per visualizzare la sopravvivenza dei pazienti e il modello di Cox.

Infine, per quanto riguarda la presentazione dei risultati, abbiamo fatto in modo che il lettore possa comprendere facilmente i risultati ottenuti.

+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| #### **Variabile** | #### **Tipologia** | #### **Descrizione**                                                                                                                                                                                 |
+:===================+:===================+:=====================================================================================================================================================================================================+
| PAZIENTE           | *Numeric*          | ID del paziente.                                                                                                                                                                                     |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| NASCITA            | *Character*        | Data di nascita del paziente.                                                                                                                                                                        |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| SEX                | *Numeric*          | Sesso del paziente (1 = uomo ; 2 = donna).                                                                                                                                                           |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| STATOCIV           | *Numeric*          | Stato civile del paziente( 1 = non sposato/a senza partner ;2 = coniugato/a; 3 = convivente; 4 = separato/divorziato; 5 = vedovo/a).                                                                 |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| PESO               | *Numeric*          | Peso del paziente (Kg).                                                                                                                                                                              |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ALTEZZA            | *Numeric*          | Altezza del paziente (Cm).                                                                                                                                                                           |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CADUTE             | *Numeric*          | Numero di cadute del paziente.                                                                                                                                                                       |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CCSCORE            | *Numeric*          | Il Charlson Comorbidity Score è un indice di gravità della malattia che viene utilizzato per valutare il rischio di mortalità e morbilità associato a comorbidità in pazienti con malattie croniche. |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| SOFAING            | *Numeric*          | Il punteggio SOFA (Sequential Organ Failure Assessment) è un indice utilizzato per valutare la gravità della disfunzione di vari organi nei pazienti.                                                |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| MMSE               | *Character*        | Il Mini-Mental State Examination (MMSE) è uno strumento di valutazione cognitiva ampiamente utilizzato per valutare la funzione cognitiva nei pazienti (-1 = Mancante ; -2 = Non valutabile).        |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ALB                | *Character*        | Albumina                                                                                                                                                                                             |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CALC               | *Character*        | Calcio                                                                                                                                                                                               |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| VITD               | *Character*        | Vitamina D                                                                                                                                                                                           |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| HBING              | *Character*        | Emoglobina                                                                                                                                                                                           |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| TEMPRIC            | *Numeric*          | Durata del ricovero del paziente in minuti ( -1 = Non disponibile ; -2 = Da altro ospedale)                                                                                                          |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| DATDIM             | *POSIXct*          | Data dimissione del paziente.                                                                                                                                                                        |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| DATINT             | *POSIXct*          | Data intervento del paziente.                                                                                                                                                                        |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| INTDURAT           | *Numeric*          | Durata dell'intervento in minuti.                                                                                                                                                                    |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ANEST              | *Numeric*          | Tipo di anestesia utilizzata ( 1 = generale; 2 = spinale; 3 = peridurale; 4 = plessica; 5 = combinata; 6 = sedazione; 7 = locale assisitita; 8 = altro)                                              |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| DATA DECESSO       | *Numeric*          | Data decesso del paziente.                                                                                                                                                                           |
+--------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

# Preliminary Operations

Carichiamo le librerie utili alle nostre analisi.

```{r}
#Management
library(readxl)
library(stringr)
#Visualization
library(ggplot2)
library(psych)
#Descriptive
library(table1)
library(corrplot)
#Analisi di sopravvivenza
library(survival)
library(survminer)
library(ggfortify)
```

Impostiamo la directory.

```{r}
setwd("C:/Users/Simone/Documents/Desktop/EDA_SOFA-Biostatistic")
```

# Data loading

Carichiamo i dati.

```{r}
data <- read_excel("SOFA.xlsx")
head(data)
```

Struttura del dataset.

```{r}
#Struttura del dataset
str(data)
```

Si può notare come ci sia la presenza di alcuni formati errati e valori anomali.

```{r}
#Statistiche descrittive
summary(data)
```

Confermiamo la presenza di valori anomali.

```{r}
#Conta il numero di valori mancanti per ciascuna variabile del dataset
colSums(is.na(data))
```

Osservando i dati si può notare la presenza di valori mancanti, inoltre nelle distribuzioni delle variabili si notano valori anomali e valori che necessitano di una correzione, da queste premesse iniziamo la fase di cleaning e preprocessing del dataset.

# Data Cleaning

Il data cleaning è il processo di identificazione e correzione di errori, incoerenze e dati mancanti all'interno di un dataset, per comodità, data la dimensione del dataset, abbiamo deciso di correggere ogni variabile manualmente.

**Paziente**

Controlliamo l'eventuale presenza dei duplicati.

```{r}
data$PAZIENTE[duplicated(data$PAZIENTE)]
data[data$PAZIENTE== 16,]
```

Si nota la presenza di due pazienti che hanno lo stesso numero identificativo, ma i valori delle altre colonne sono diverse, deduciamo che si tratti di due pazienti distinti, dunque procediamo con la correzione.

```{r}
data[7,1] = 17
data[7,1]
data[data$PAZIENTE==16 | data$PAZIENTE==17,]
```

**Nascite**

```{r}
data$NASCITA
```

Come avevamo già notato le date hanno dei valori insensati, questo è dovuto al fatto che R non legge bene i file excel, inoltre c'è un valore da correggere per il paziente 111 e tre valori che contengono errori di battitura.

```{r}
(i <- data[data$PAZIENTE==111,])
data$NASCITA[data$PAZIENTE==111]=sapply(Map(append, strsplit(i$NASCITA,""), after = nchar(i$NASCITA) - 4, "/"), paste, collapse = "")
data[data$PAZIENTE==111,]
```

Trasformiamo i numeri in data considerando come origine il "1899-12-30"

```{r}
data$NASCITA = as.numeric(data$NASCITA)
(data$NASCITA = as.Date(x = data$NASCITA,origin = "1899-12-30", ))
```

Procediamo con la correzione dei tre valori mancanti, che altro non sono che i tre errori di battitura che si possono osservare nel Dataset.

```{r}
data$NASCITA[c(43, 61, 34)] = as.Date(c("1928/03/16","1922/07/04","1929/07/13"))
data$NASCITA
```

**SEX**

Per la variabile "SEX" decidiamo di modificare i valori numerici 1 e 2 in due stringhe, utilizzando la documentazione.

```{r}
data$SEX <- ifelse(data$SEX == 1, "uomo", "donna")
data$SEX
```

**STATCIV**

Come fatto per la variabile precedente, procediamo in modo analogo e utilizzando la documentazione andiamo a modificare i valori numerici.

```{r}
data$STATCIV <- ifelse(data$STATCIV == 1, "non_sposato\a", 
                        ifelse(data$STATCIV == 2, "coniugato\a",
                               ifelse(data$STATCIV == 3, "convivente",
                                      ifelse(data$STATCIV == 4, "divorziato\a",
                                             ifelse(data$STATCIV == 5, "vedovo\a",'NAN')))))
data$STATCIV
```

Non ci sono valori nulli e tutti i campi sono stati corretti, bisogna dire che questa operazione non è sempre indispensabile.

**Peso**

Osservando la distribuzione della variabile "PESO" sono presenti dei valori -1, andiamo a trasformare  i valori mancanti e li contiamo come se fossero dei valori nulli.

```{r}
data$PESO =ifelse(data$PESO==-1,NA,data$PESO)
sum(is.na(data$PESO) | data$PESO == "NA")

```

Osserviamo la nuova distribuzione.

```{r}
boxplot(data$PESO, 
        col = "grey",   
        border = "black",  
        names = c("PESO"),
        ylab = "PESO",     
        pch = 19,
        main= "Distribuzione MMSE") 
points(x = rep(1, length(data$PESO)), y = data$PESO, pch = 19, col = "red")
legend("topright", legend = "Pazienti", pch = 19, col = "red")
```

Notiamo come ci siano alcuni outlier, soprattutto una paziente ha un peso che equivale a 33kg.
Osservando però i valori delle altre colonne ed anche l'età avanzata di molti pazienti, come si può vedere facilmente dando uno sguardo al boxplot, abbiamo deciso momentaneamente di non eliminare l'osservazione.

**ALTEZZA**

Osservando la variabile "ALTEZZA" si notano due valori "-1" e "9" che necessitano di una correzzione.

```{r}
data$ALTEZZA = ifelse(data$ALTEZZA< 100,NA,data$ALTEZZA)
data$ALTEZZA
```

Osserviamo la distribuzione.

```{r}
boxplot(data$ALTEZZA, 
        col = "grey",   
        border = "black",  
        names = c("ALTEZZA"),
        ylab = "ALTEZZA",     
        pch = 19,
        main= "Distribuzione ALTEZZA") 
points(x = rep(1, length(data$ALTEZZA)), y = data$ALTEZZA, pch = 19, col = "red")
legend("topright", legend = "Pazienti", pch = 19, col = "red")
```

C'è un solo outlier di un paziente alto 135 cm, ma osservando il suo peso e altri valori, momentaneamente non lo eliminiamo.

**CADUTE**

La variabile "CADUTE" presenta dei valori anomali corrispondenti a -1, procediamo a corregerli.

```{r}
data$CADUTE = ifelse(data$CADUTE<0,NA,data$CADUTE)
data$CADUTE
```

**CCSCORE**

La variabile "CCSCORE" non sembra presentare problemi.

```{r}
data$CCSCORE
```

**SOFAING**

La variabile "SOFAING" non sembra presentare problemi.

```{r}
data$SOFAING
```

**MMSE**

La variabile "MMSE" presenta dei valori corrispondenti a "-1 = mancante" e "-2 = non valutabile", inoltre alcuni valori sono separati da virgole ed altri da punti, procediamo a corregerli.

```{r}
data$MMSE = ifelse(data$MMSE<0,NA,data$MMSE)
data$MMSE = str_replace(data$MMSE, ",", ".")
data$MMSE = as.numeric(data$MMSE)
data$MMSE
```

Osserviamo la distribuzione.

```{r}
boxplot(data$MMSE, 
        col = "grey",   
        border = "black",  
        names = c("MMSE"),
        ylab = "MMSE",     
        pch = 19,
        main= "Distribuzione MMSE") 
points(x = rep(1, length(data$MMSE)), y = data$MMSE, pch = 19, col = "red")
legend("topright", legend = "Pazienti", pch = 19, col = "red")
```

Notiamo come ci sia un paziente con un valore uguale a "0" che sta a significare un massimo deficit cognitivo.

**ALB**

La variabile "ALB" presenta valori "-1" e inoltre alcuni valori sono separati da virgole ed altri da punti, procediamo a formalizzare il tutto.

```{r}
data$ALB = ifelse(data$ALB==-1,NA,data$ALB)
data$ALB = str_replace(data$ALB, ",", ".")
data$ALB = as.numeric(data$ALB)
data$ALB
```

Controlliamo la distribuzione.

```{r}
boxplot(data$ALB, 
        col = "grey",   
        border = "black",  
        names = c("ALB"),
        ylab = "ALB",     
        pch = 19,
        main= "Distribuzione ALB")   
points(x = rep(1, length(data$ALB)), y = data$ALB, pch = 19, col = "red")
legend("topright", legend = "Pazienti", pch = 19, col = "red")
```

Notiamo come ci sia molta differenza tra i valori di albumina.

**CALC**

La variabile "CALC" ha alcuni valori separati da virgole ed altri da punti, procediamo a formalizzare il tutto.

```{r}
data$CALC = str_replace(data$CALC, ",", ".")
data$CALC = as.numeric(data$CALC)
data$CALC
```

Notiamo un valore pari a 880, probabilmente un errore di battitura, correggiamolo dividendolo per 100.

```{r}
data$CALC[23]= data$CALC[23]/100
```

Osserviamo la distribuzione.

```{r}
boxplot(data$CALC, 
        col = "grey",   
        border = "black",  
        names = c("CALC"),
        ylab = "CALC",     
        pch = 19,
        main= "Distribuzione CALC")
points(x = rep(1, length(data$CALC)), y = data$CALC, pch = 19, col = "red")
legend("topright", legend = "Pazienti", pch = 19, col = "red")
```

Osserviamo la presenza di due outlier con valori molto bassi di calcio.

**VITD**

Ci sono diversi valori da correggere come i valori "-1" e sono presenti alcuni valori separati da virgole ed altri da punti, procediamo a formalizzare il tutto.


```{r}
data$VITD = str_replace(data$VITD, ",", ".")
data$VITD = ifelse(data$VITD==-1,NA,data$VITD)
data$VITD = as.numeric(data$VITD)
data$VITD
```

Osserviamo la distribuzione.

```{r}
boxplot(data$VITD, 
        col = "grey",   
        border = "black",  
        names = c("VITD"),
        ylab = "VITD",     
        pch = 19,
        main= "Distribuzione VITD")
points(x = rep(1, length(data$VITD)), y = data$VITD, pch = 19, col = "red")
legend("topright", legend = "Pazienti", pch = 19, col = "red")
```

Osserviamo la presenza di 3 outlier, cioè tre pazienti che rispetto al resto del campione hanno dei valori di Vitamina D molto elevata.

**HBING**

Notiamo che anche qui sono presenti alcuni valori separati da virgole ed altri da punti, procediamo a formalizzare il tutto.

```{r}
data$HBING = str_replace(data$HBING, ",", ".")
data$HBING = as.numeric(data$HBING)
data$HBING
```

Osserviamo la distribuzione

```{r}
boxplot(data$HBING, 
        col = "grey",   
        border = "black",  
        names = c("HBING"),
        ylab = "HBING",     
        pch = 19,
        main= "Distribuzione HBING")
points(x = rep(1, length(data$HBING)), y = data$HBING, pch = 19, col = "red")
legend("topright", legend = "Pazienti", pch = 19, col = "red")
```

Anche in questo caso ci sono degli outlier sia oltre il limite superiore che inferiore dell'intera distribuzione.

**TEMPRIC**

Nella variabile "TEMPRIC" ci sono dei "-1" riferiti al valore non disponibile e dei "-2" che indicano la provenienza del paziente da un altro ospedale, procediamo con la correzione trattandoli come "NA".

```{r}
data$TEMPRIC = ifelse(data$TEMPRIC<0,NA,data$TEMPRIC)
data$TEMPRIC
```

```{r}
boxplot(data$TEMPRIC, 
        col = "grey",   
        border = "black",  
        names = c("TEMPRIC"),
        ylab = "TEMPRIC",     
        pch = 19,
        main= "Distribuzione TEMPRIC(in minuti)")
points(x = rep(1, length(data$TEMPRIC)), y = data$TEMPRIC, pch = 19, col = "red")
legend("topright", legend = "Pazienti", pch = 19, col = "red")
```

Notiamo come per la maggior parte dei pazienti la durata del ricovero sia compresa tra i 0 e i 300 minuti.

**DATADIM**

La variabile "DATADIM" non presenta valori da correggere.

```{r}
data$DATDIM
```

**DATAINT**

La variabile "DATAINT" non presenta errori da corregere, ma confrontando alcune osservazioni con la colonna della data di dimissione notiamo come per due pazienti questa è prima della data di intervento.

```{r}
errors <- ifelse(difftime(data$DATDIM, data$DATINT, units = "days") >= 0, TRUE, FALSE)
indici <- which(!errors)
data[indici, ]
nrow(data)
```

Possiamo eliminare le righe dei due pazienti o eliminare la data di dimissione, procediamo sostituendo con "NA" la data di dimissione.

```{r}
#Cancellare le righe
#data <- subset(data, !(PAZIENTE %in% c(29, 145)))
# Seleziona le righe in cui data$PAZIENTE è uguale a 29 o 145
indice <- which(data$PAZIENTE == 29 | data$PAZIENTE == 145)

# Trasforma i valori della colonna data$DATDIM in NA per le righe selezionate
data$DATDIM[indice] <- NA
data$DATDIM
nrow(data)

```

**INTDURAT**

La variabile "INTDURAT" non sembra presentare errori anomali o valori mancanti.

```{r}
data$INTDURAT
```

Osserviamo la distribuzione.

```{r}
boxplot(data$INTDURAT, 
        col = "grey",   
        border = "black",  
        names = c("INTDURAT"),
        ylab = "INTDURAT",     
        pch = 19,
        main= "Distribuzione INTDURAT")
points(x = rep(1, length(data$INTDURAT)), y = data$INTDURAT, pch = 19, col = "red")
legend("topright", legend = "Pazienti", pch = 19, col = "red")
```

**ANEST**

Cambiamo i valori della variabile "ANEST" utilizzando la documentazione.

```{r}
nuovi_valori <- c("generale", "spinale", "peridurale", "plessica", "combinata", "sedazione", "locale_assistita", "altro")

data$ANEST <- ifelse(data$ANEST == 1, nuovi_valori[1], 
                     ifelse(data$ANEST == 2, nuovi_valori[2], 
                            ifelse(data$ANEST == 3, nuovi_valori[3], 
                                   ifelse(data$ANEST == 4, nuovi_valori[4], 
                                          ifelse(data$ANEST == 5, nuovi_valori[5], 
                                                 ifelse(data$ANEST == 6, nuovi_valori[6], 
                                                        ifelse(data$ANEST == 7, nuovi_valori[7], 
                                                               ifelse(data$ANEST == 8, nuovi_valori[8], 
                                                                      data$ANEST))))))))
data$ANEST
```

**DATA DECESSO**

La variabile "DATA DECESSO" presenta molteplici errori: innanzitutto ci sono valori uguali a "-1" che equivalgono a "Si è rifiutata"; dopo di che le date sono rappresentate con valori di tipo non numerico, procediamo con la correzione.

```{r}
data$'DATA DECESSO'
```

La variabile "DATA DECESSO" presenta molteplici errori: innanzitutto ci sono valori uguali a "-1" che equivalgono a "Si è rifiutata"; dopo di che le date sono rappresentate con valori di tipo non numerico, procediamo con la correzione di tutti i valori.

```{r}
data$'DATA DECESSO' = ifelse(data$`DATA DECESSO`=='SI è RIFIUTATA',NA,data$`DATA DECESSO`)
data$'DATA DECESSO' = ifelse(data$`DATA DECESSO`== -1,NA,data$`DATA DECESSO`)
data$'DATA DECESSO' = as.numeric(data$`DATA DECESSO`)
(data$'DATA DECESSO' = as.Date(x = data$`DATA DECESSO`,origin = "1899-12-30", ))
data$'DATA DECESSO'
```

Abbiamo concluso la fase di cleaning, ogni variabile è stata ripulita, confermiamo la presenza di molti outlier, abbiamo deciso di non eliminarli per non ridurre ulteriormente la dimensione del dataset.

# Pre Processing

In questa fase andiamo a creare delle nuove variabili per il nostro dataset che ci serviranno successivamente.
Andiamo a definire nuove variabili dividendo i punteggi in classi.

**CCSCORE_classe**

Dividiamo il punteggio "CCSCORE" in tre classi: basso, medio, alto.

```{r}
data$CCSCORE<-as.numeric(data$CCSCORE)
data$CCSCORE_classe = ifelse((data$CCSCORE==0 |data$CCSCORE==1 |data$CCSCORE==2),'cc_basso',
ifelse((data$CCSCORE==3|data$CCSCORE==4),'cc_medio','cc_alto'))
(table(data$CCSCORE_classe))
```

**SOFAING_classe**

Dividiamo il punteggio "SOFAING" in due classi: basso e alto.

```{r}
data$SOFAING_classe = ifelse(data$SOFAING== '0','sofa_basso', 'sofa_alto')
table(data$SOFAING_classe)
```

**MMSE_classe**

Dividamo il punteggio "MMSE" in quattro classi: grave, moderato, lieve, normale.

```{r}
data$MMSE_classe <- data$MMSE

# Raggruppare i punteggi in classi
data$MMSE_classe <- cut(data$MMSE, breaks = c(-1, 9, 18, 23, 30), 
                                    labels = c("grave", "moderato", "lieve", "normale"))

#Conteggio delle osservazioni in ogni classe
table(data$MMSE_classe)
```

**BMI e BMI_classe**

Andiamo a creare la variabile "BMI" e le sue classi.
Il BMI (Body Mass Index) è un indice che indica la relazione tra il peso e l'altezza di una persona.

```{r}
data$PESO<-as.numeric(data$PESO)
data$ALTEZZA<-as.numeric(data$ALTEZZA)
data$BMI<-(data$PESO)/((data$ALTEZZA/100)^2)
data$BMI_classi = ifelse(data$BMI<18.5,'sottopeso',ifelse(data$BMI<25,'normopeso','sovrappeso'))
head(data$BMI)
table(data$BMI_classi)
```

**AGE e AGE_classe**

Calcoliamo l'età dei pazienti, assumendo la data di intervento come riferimento per il calcolo, anche questa variabile la dividiamo in classi.


```{r}
# calculate the age in years
data$AGE <- as.numeric(difftime(data$DATINT, data$NASCITA, units = "weeks")) / 52.25
data$AGE <- trunc(data$AGE)
cat("data$AGE =", data$AGE, "\n")
```

Il range delle classi viene fissato a 5 anni.

```{r}
breakpoints <- c(69, 75, 80, 85, 90, 95, 105)
data$AGE_classi <- cut(data$AGE, breakpoints, labels = c("70-75", "75-80", "80-85", "85-90", "90-95", "95-100+"))
table(data$AGE_classi)
```

```{r}
data$AGE_classi
```

**GGOSSERV e ANNIOSSERV**

Infine andiamo a calcolare i giorni che il paziente rimane in osservazione dalla durata dell'intervento ad una data decisa a priori, assumendo che i paienti rimangano sotto osservazione della clinica; questa variabile ci servirà per la costruzione della curva di sopravvivenza.

```{r}

data$fine_data = ifelse(is.na(data$`DATA DECESSO`),NA,data$`DATA DECESSO`)
data$fine_data =as.numeric(data$fine_data)
data$fine_data =as.Date(data$fine_data,origin = "1970-01-01", )
data$fine_data = ifelse(is.na(data$fine_data),as.Date("2021/12/31"),data$fine_data)
data$fine_data =as.Date(data$fine_data,origin = "1970-01-01", )

```

```{r}
data$GGOSSERV = as.numeric(difftime(data$fine_data, data$DATINT, units = "days"))
data$GGOSSERV
```

Osserviamo due valori negativi, quindi questo significa che ci sono due date incongruenti tra data decesso ed intervento, considerando che la data di decesso è un dato molto importante e significativo, decidiamo di eliminare tutti i dati riguardanti questi pazienti per non influire sulle nostre analisi.

```{r}
data <- subset(data, GGOSSERV>=0)
```

Creiamo la variabile "ANNIOSSERV".

```{r}
data$ANNIOSSERV<- data$GGOSSERV/365
data$ANNIOSSERV <- trunc(data$ANNIOSSERV)
cat("data$ANNIOSSERV =", data$ANNIOSSERV, "\n")
```

# Exploratory data analysis

L'EDA è una metodologia analitica che prevede l'esplorazione dei dati in modo visivo e statistico, al fine di comprendere le caratteristiche del dataset e le relazioni tra le variabili; può essere applicata a questo dataset per identificare eventuali relazioni tra le variabili, ad esempio per verificare se esiste una correlazione tra il punteggio SOFA e il CCScore, o se esiste una relazione tra le caratteristiche dei pazienti e i loro punteggi di gravità.

**Missing values**

Analizziamo la presenza di valori mancanti.

```{r}
library(ggplot2)
library(dplyr)

# Calcola il numero di valori nulli per ogni colonna
null_counts <- sapply(data, function(x) sum(is.na(x)))

# Calcola le percentuali di valori nulli per ogni colonna
null_percents <- null_counts / nrow(data) * 100

# Crea un dataframe con i valori delle colonne
null_data <- data.frame(col = names(data), count = null_counts, percent = null_percents)

# Filtra le colonne con valore nulli
null_data <- null_data %>% filter(count > 0)

# Ordina il dataframe in base al numero di valori mancanti
null_data <- null_data[order(null_data$count, decreasing = TRUE),]

# Crea il grafico a barre orizzontale
ggplot(null_data, aes(x = reorder(col, -count), y = count, fill = "lightpink")) +
  geom_bar(stat = "identity") +
  ggtitle("Numero e percentuale di valori mancanti per variabile") +
  xlab("Variabile") +
  ylab("Numero di valori mancanti") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none") +
  scale_fill_brewer(palette = "Set2") +
  geom_text(aes(label = paste0(round(percent, 1), "%")), 
            hjust = -0.1, size = 3, color = "black") +
  coord_flip() +
  scale_y_continuous(limits = c(0, max(null_data$count)))

```

Nel caso della variabile "data decesso" che contiene valori nulli all'80%, questo può indicare che la maggior parte dei pazienti è in vita oppure che le informazioni sul decesso non sono state registrate o non sono disponibili.
In questo caso, sarà necessario valutare attentamente come gestire questi dati mancanti.

La variabile "VITD" con valori nulli al 25% potrebbe comunque essere utilizzata nell'analisi, a patto che il numero di valori mancanti non influisca in modo significativo sulla potenza dell'analisi o sulla rappresentatività del campione, anche la variabile "DATDIM" che indica la data di dimissione contiente un numero significativo di valori nulli.

Infine, la presenza di pochi valori nulli (sotto il 5%) può essere considerata un valore accettabile e non influente sull'analisi, tuttavia, anche in questi casi, è importante verificare la ragione per cui questi valori sono mancanti.

**Analisi delle principali variabili rispetto alle classi di età**

Un'analisi delle principali variabili rispetto alle classi di età può aiutare a comprendere le differenze tra le varie fasce d'età in termini di variabili di interesse.
Ciò può fornire informazioni preziose per la gestione delle malattie e per lo sviluppo di interventi di prevenzione e trattamento specifici per le diverse fasce d'età.

Andremo ad esaminare come variano "BMI", "SOFA", "CC-score", "MMSE-score" in base all'età dei pazienti.

```{r}
# Calcola il numero di donne e uomini
age_count <- table(data$AGE_classi)

# Crea il barplot
barplot(age_count, 
        main = "Distribuzione delle classi di età", 
        xlab = "Classi d'età", 
        ylab = "Numero di individui", 
        col = c( "lightblue"))
```

La maggior parte dei pazienti è compresa nell'intervallo di età da 80 a 90 anni.

```{r}
ggplot(data, aes(x = BMI_classi, fill = AGE_classi)) +
  geom_bar(position = "dodge") +
  ggtitle("Distribuzione classi di età per le classi BMI") +
  xlab("Classe di età") +
  ylab("Conteggio") +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(breaks = seq(0, 15, 2))
```

La maggior parte dei pazienti è normopeso, soprattutto nelle fasce d'età da 75 a 90 anni, questo suggerisce che il peso corporeo dei pazienti in queste fasce d'età sia generalmente adeguato rispetto all'età e alla statura, tuttavia, è importante notare che il peso corporeo può essere influenzato da fattori come l'attività fisica, la dieta, le condizioni di salute e i farmaci.

Inoltre, il fatto che circa 15 pazienti su 62 siano in sovrappeso, di cui 7 pazienti sono nella fascia d'età 80-85, suggerisce che l'aumento di peso può essere un problema significativo per alcune persone anziane.

```{r}
ggplot(data, aes(x = CCSCORE_classe, fill = AGE_classi)) +
  geom_bar(position = "dodge") +
  ggtitle("Distribuzione classi di età per le classi  CCSCORE") +
  xlab("Classe di età") +
  ylab("Conteggio") +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(breaks = seq(0, 15, 2))
```

Circa la metà dei pazienti ha un "CC-score" basso, questo suggerisce che molti pazienti non presentano molte comorbidità.
Al contrario, il fatto che circa 20 pazienti abbiano un "CC-score" medio suggerisce che un certo numero di pazienti potrebbe avere comorbilità moderate.
Inoltre, l'assenza di pazienti con "CC-score" alto nella fascia d'età 75-80 suggerisce che potrebbero avere una buona salute generale.

```{r}
ggplot(data, aes(x = SOFAING_classe, fill = AGE_classi)) +
  geom_bar(position = "dodge") +
  ggtitle("Distribuzione classi di età per le classi  SOFA") +
  xlab("Classe di età") +
  ylab("Conteggio") +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(breaks = seq(0, 15, 2))
  
```

La maggior parte dei pazienti ha un "SOFA" basso, questo suggerisce che molti pazienti potrebbero non avere comorbilità significative, quindi potrebbe essere un fattore positivo per la loro salute e il loro benessere generale.

Inoltre, il fatto che ci siano solo due pazienti con uno score alto nella fascia d'età 70-80 suggerisce che i pazienti in questa fascia d'età potrebbero essere relativamente sani.

```{r}
ggplot(data, aes(x = MMSE_classe, fill = AGE_classi)) +
  geom_bar(position = "dodge") +
  ggtitle("Distribuzione del genere per le classi MMSE") +
  xlab("MSE") +
  ylab("Conteggio") +
  scale_fill_brewer(palette = "Set2")+
scale_y_continuous(breaks = seq(0, 15, 2))
```

L'omogeneità della distribuzione delle classi di età rispetto ai livelli di "MMSE" suggerisce che l'età potrebbe non essere un fattore determinante nella capacità cognitiva dei pazienti.
Tuttavia, il fatto che la maggior parte dei pazienti nella fascia d'età 70-80 abbia valori "MMSE" più normali e lievi rispetto alle altre classi potrebbe indicare una maggiore prevalenza di problemi cognitivi in età più avanzata.

**Analisi delle principali variabili rispetto al sesso**

Andiamo ad analizzare le distribuzioni di genere in base alle variabili più importanti: Età, BMI, CC score, SOFA e MMSE. 
Osserviamo il numero di donne e uomini presenti nel dataset.

```{r}
# Calcola il numero di donne e uomini
sex_counts <- table(data$SEX)

# Crea il barplot
barplot(sex_counts, 
        main = "Distribuzione di genere nel dataset", 
        xlab = "Genere", 
        ylab = "Numero di individui", 
        col = c("lightpink", "steelblue"))
```

Notiamo come la maggior parte dei pazienti sono donne, questa variabile risulta molto sbilanciata quindi successivamente sarà meglio svolgere analisi di genere per non creare distorsioni fra i dati.

Osserviamo la distribuzioni di genere rispetto alle classi di età.

```{r}
ggplot(data, aes(x = AGE_classi, fill = SEX)) +
  geom_bar(position = "dodge") +
  facet_grid(. ~ SEX) +
  ggtitle("Distribuzione di genere e delle classi di età") +
  xlab("Classe di età") +
  ylab("Conteggio") +
  scale_fill_brewer(palette = "Set2")+
  scale_y_continuous(breaks = seq(0, 20, 2))
```

Come osservato precedentemente, i pazienti sono molto anziani e con un età maggiormente compresa fra 80 e 90 anni.

```{r}
ggplot(data, aes(x = BMI_classi, fill = SEX)) +
  geom_bar(position = "dodge") +
  facet_grid(. ~ SEX) +
  ggtitle("Distribuzione di genere per le classi  BMI") +
  xlab("BMI") +
  ylab("Conteggio") +
  scale_fill_brewer(palette = "Set2")+
scale_y_continuous(breaks = seq(0, 30, 4))
```

Più del 50% dei pazienti ha un peso corporeo adeguato alla propria età, inoltre notiamo 15 pazienti donna in sovrappeso.

```{r}
ggplot(data, aes(x = CCSCORE_classe, fill = SEX)) +
  geom_bar(position = "dodge") +
  facet_grid(. ~ SEX) +
  ggtitle("Distribuzione di genere per le classi  CCSCORE") +
  xlab("CCSCORE") +
  ylab("Conteggio") +
  scale_fill_brewer(palette = "Set2")+
scale_y_continuous(breaks = seq(0, 25, 2))
```

La maggior parte dei pazienti donna presenta un "CC-score" basso, questo può essere un indicatore di una migliore salute generale dell'individuo e di un minor rischio di complicanze mediche associate a malattie croniche, tuttavia, non significa necessariamente che l'individuo sia completamente privo di malattie o di altre condizioni mediche.
17 pazienti donne presentano un "CC-score" medio e 9 un "CC-score" alto, ciò potrebbe indicare che la popolazione in questione può avere un elevato rischio di malattie croniche.

Per gli uomini le classi sono più omogenee e non ci sono grandi differenze.

```{r}
ggplot(data, aes(x = SOFAING_classe, fill = SEX)) +
  geom_bar(position = "dodge") +
  facet_grid(. ~ SEX) +
  ggtitle("Distribuzione di genere per le classi  SOFA") +
  xlab("SOFA") +
  ylab("Conteggio") +
  scale_fill_brewer(palette = "Set2")+
  scale_y_continuous(breaks = seq(0, 40, 5))
```

Un SOFA basso indica che la funzionalità degli organi è relativamente stabile e non ci sono segni di insufficienza grave, tuttavia, bisogna anche considerare il fatto che il SOFA non fornisce una valutazione completa dello stato di salute del paziente e non tiene conto di altri fattori importanti come la storia medica, la terapia attuale e il decorso della malattia.

La maggior parte dei pazienti donna ha un punteggio SOFA basso, ciò potrebbe suggerire che queste donne sono in una condizione relativamente stabile e non presentano una grave insufficienza d'organo.

```{r}
ggplot(data, aes(x = MMSE_classe, fill = SEX)) +
  geom_bar(position = "dodge") +
  facet_grid(. ~ SEX) +
  ggtitle("Distribuzione di genere e per le classi di MMSE") +
  xlab("MSE") +
  ylab("Conteggio") +
  scale_fill_brewer(palette = "Set2")
```

La maggior parte dei pazienti ha un punteggio "MMSE" normale-lieve, ciò suggerisce che la loro funzione cognitiva è generalmente buona e che non vi sono gravi problemi di memoria, attenzione e ragionamento.
Circa 15 pazienti su un totale di 62 hanno un punteggio "MMSE" moderato-grave, ciò suggerisce che questi pazienti potrebbero avere problemi significativi di memoria, attenzione e ragionamento.

**Funzione cumulata per SOFA e CCSCORE**

Una funzione cumulata dell'età rispetto allo "SOFA" può fornire informazioni sul modo in cui la salute dei pazienti cambia con l'età.

La seguente funzione rappresenta la distribuzione cumulata delle osservazioni rispetto alla variabile di età e al punteggio SOFA.

```{r}
#funzione empirica cumulata dell'età divisa per sesso
data$SOFAING = as.numeric(data$SOFAING)
a <- ggplot(data, aes(x = SOFAING))+theme(panel.background = element_rect(fill = "white" ))+ ggtitle("Plot of length \n by dose") + ylab("età cumulata") + xlab("Sofa")

#funzione empirica cumulata
pl =a + stat_ecdf(aes(color = SEX,linetype = SEX),

geom = "step", size = 1.5) +

scale_color_manual(values = c("lightpink", "steelblue"))+
labs(y = "f(eta)")+theme(panel.background = element_rect(fill = "white" ))

bxp <- pl + labs(title = "Funzioni cumulate Età - SOFA",

subtitle = "Frequenze cumulate punteggio sofa per età e genere",
x = "Punteggio SOFA", y = "Frequenza cumulata età")

bxp
```

Il fatto che la funzione cumulata che rappresenta le donne sia sopra quella degli uomini per i punteggi SOFA da 0 a 2 potrebbe indicare che le donne in generale presentano meno comorbilità rispetto agli uomini nella stessa fascia di età.
Tuttavia, il fatto che le funzioni si allineino per i punteggi SOFA da 2 a 4 potrebbe indicare che la relazione tra età e "SOFA" è simile per uomini e donne.
L'analisi delle funzioni cumulate potrebbe suggerire la presenza di differenze di genere nella distribuzione dei punteggi SOFA in relazione all'età, ma è importante considerare ulteriori informazioni e condizioni specifiche del dataset per una corretta interpretazione.

```{r}
#funzione empirica cumulata dell'età divisa per sesso
data$CCSCORE = as.numeric(data$CCSCORE)
a <- ggplot(data, aes(x = CCSCORE))+theme(panel.background = element_rect(fill = "white" ))+ ggtitle("Plot of length \n by dose") + ylab("età cumulata") + xlab("CCSCORE")

#funzione empirica cumulata
pl =a + stat_ecdf(aes(color = SEX,linetype = SEX),

geom = "step", size = 1.5) +

scale_color_manual(values = c("lightpink", "steelblue"))+
labs(y = "f(eta)")+theme(panel.background = element_rect(fill = "white" ))

bxp <- pl + labs(title = "Funzioni cumulate Età - CC score",

subtitle = "Frequenze cumulate punteggio CCSCORE
per età e genere",
x = "Punteggio CC score", y = "Frequenza cumulata età")

bxp
```

Le funzioni cumulate per uomini e donne dopo il valore 2 si incrociano frequentemente, ciò potrebbe indicare che non vi è una forte associazione tra l'età e il CCscore e/o che non vi sono differenze significative tra uomini e donne.

Tuttavia, è importante considerare l'intervallo di età e il campione di pazienti inclusi nello studio.
Ad esempio, se l'intervallo di età è ampio e il campione di pazienti è relativamente piccolo, le differenze tra gli uomini e le donne potrebbero non essere sufficientemente rappresentative.

**Classificazione variabili principali rispetto a SOFA e CCSCORE**

```{r}
pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}

table1(~ SEX + AGE  + AGE_classi + BMI + BMI_classi  + MMSE_classe + CCSCORE_classe  | SOFAING_classe, data=data, overall=F, extra.col=list('P-value'=pvalue))
```

In questa tabella viene presentata una descrizione delle variabili principali classificate in base al punteggio SOFA, dove per le variabili categoriche viene confrontata la numerosità tra i gruppi e le loro percentuali, mentre per quelle numeriche vengono osservate la media con la deviazione standard e la mediana con il range di appartenenza.

Si può notare come ci sia una maggior presenza di pazienti con SOFA basso, che è prevalentemente di genere femminile con un'età molto alta, superiore agli 80 anni in entrambe le categorie di SOFA e con un BMI normale.
Inoltre, osservando la variabile "CC-score", si nota come nella categoria SOFA alto si definiscono pazienti con un punteggio di comorbilità medio/alto, mentre nella categoria SOFA basso il 58% dei pazienti ha un CC-score basso.
Il P-value rappresenta la probabilità che l'effetto osservato o la differenza tra i gruppi o la relazione tra le variabili non siano dovuti al caso, ma siano effettivamente presenti nella popolazione di riferimento, è importante notare che in questo caso le variabili risultano non significativi al 5% , tranne che per la classe CC-score", quindi possiamo affermare che esiste una relazione significativa tra i due punteggi.

```{r}
pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}

# create a new function for the inverted grouping factors
pvalue_inverted <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform an ANOVA test
        p <- anova(lm(y ~ g))$"Pr(>F)"[1]
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(g, y))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}

# use the new function for the inverted grouping factors
table1(~ SEX + AGE + AGE_classi + BMI + BMI_classi + MMSE_classe +SOFAING_classe | CCSCORE_classe, data = data, overall = FALSE, extra.col = list('P-value' = pvalue_inverted))

```
In questa tabella viene presentata una descrizione delle variabili principali classificate in base al CC-score, dove per le variabili categoriche viene confrontata la numerosità tra i gruppi e le loro percentuali, mentre per quelle numeriche vengono osservate la media con la deviazione standard e la mediana con il range di appartenenza.

Per quanto riguarda il sesso, la maggioranza dei pazienti in tutti e tre i gruppi sono donne, ma non c'è una differenza significativa tra i gruppi (p = 0,683).
Inoltre, non ci sono differenze significative tra i gruppi per l'età e il BMI.

Tuttavia, c'è una differenza significativa nella distribuzione dei punteggi del MMSE tra i gruppi (p = 0,0163), con la maggior parte dei pazienti del gruppo "sofaing_classe" con disfunzione degli organi moderata che hanno un deficit cognitivo grave (22,7%).

Infine, la distribuzione dei pazienti in base all'età e al BMI, suddivisi in classi, non mostra differenze significative tra i gruppi.

**CCSCORE e SOFA** 

Andiamo ad anaizzare la relazione tra le variabili SOFA e CCSCORE in base al genere.

```{r}
table1(~ CCSCORE_classe | SOFAING_classe*SEX, data=data,overall=F, extra.col=list('P-value'=pvalue))
```

La tabella mostra che, tra le donne, il gruppo sofa_alto è presente in maggioranza tra coloro che appartengono alla classe di gravità cc_medio (50.0%), mentre tra gli uomini, il gruppo sofa_basso è più rappresentato tra coloro che appartengono alla classe di gravità cc_basso (60.0%).

Il test di significatività (P-value) indica che non c'è evidenza di una differenza significativa tra le distribuzioni dei gruppi in base alla classe di gravità tra donne e uomini.

```{r}

my_colors <- c("lightblue", "steelblue")

ggplot(data, aes(x = SOFAING_classe, y = CCSCORE, fill = SOFAING_classe)) +
  geom_violin(trim = FALSE, scale = "width") +
  stat_boxplot(geom = 'errorbar', width = 0.2, notch = TRUE, varwidth = TRUE) +
  stat_summary(fun.y = median, geom = "point", shape = 21, size = 3, color = "white", fill = "red") +
  stat_summary(fun.y = mean, geom = "point", shape = 23, size = 3, color = "white", fill = "black") +
  geom_jitter(position = position_jitter(0.1), size = 0.5, alpha = 0.5) +
  scale_fill_manual(values = my_colors) +
  labs(x = " ", y = "CCSCORE") +
  ggtitle("Violin plot per ogni categoria di SOFA") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")

```

Osservando il grafico, confermiamo quanto detto precedentemente.

**Analisi correlazione**

La matrice di correlazione può essere utilizzata per identificare le relazioni tra le variabili e per selezionare le variabili per un ulteriori analisi.

```{r}

data_num <- select_if(data, is.numeric)#Prendo solo variabili numeriche
data_num <- subset(data_num, select = -PAZIENTE) # Elimino la variabile PAziente
corr<-cor(na.omit(data_num))# Elimino NA
corr
```

La tabella mostra la matrice di correlazione tra diverse variabili.
Ogni cella mostra il coefficiente di correlazione tra due variabili.
Il coefficiente di correlazione varia da -1 a 1 e misura la forza e la direzione della relazione lineare tra le due variabili.
Un coefficiente di 1 indica una perfetta correlazione positiva, mentre un coefficiente di -1 indica una perfetta correlazione negativa.
Un coefficiente di 0 indica l'assenza di correlazione tra le due variabili.

```{r}
pairs.panels(data_num, ellipses = F, lm=T,bg = c('blue','pink')[data$SEX],pch= 21, stars=FALSE, cex = 1)
```

```{r}
# Visualizzazione della matrice di correlazione
par(mar=c(0,0,2,0))
corrplot(corr, method = "color", type = "lower", order = "hclust",
addCoef.col = "black", number.cex = 0.3,
diag = FALSE, tl.cex = 0.9, tl.srt = 90,
cl.cex = 0.5, cl.pos = "n")
```

Considerando solo le variabili più importanti per questa analisi, è possibile osservare sia correlazioni positive che negative.
Tuttavia, il confronto più rilevante è quello tra il punteggio "SOFA" e il "CC-score".
Sebbene il coefficiente di correlazione tra queste due variabili sia debolmente positivo (forse a causa della bassa numerosità del campione), è comunque significativo.
Ciò significa che ad ogni aumento di una unità del "CC-score", il "SOFA" aumenta di circa il 26%, in altre parole, se un paziente ha più malattie contemporaneamente, il rischio di disfunzione degli organi aumenta del 26%.

# Survival analysis

Per finire, un'ulteriore analisi che si può effettuare con i dati a nostra disposizione è l'analisi di sopravvivenza.
Come prima cosa creiamo una variabile 'EVENTO'che ha i seguenti valori: 

1 = paziente deceduto 

0 = paziente vivo 

Ciò che si vuole dimostrare è che ad un elevato punteggio SOFA corrisponde un aumento del rischio di mortalità, la prima verifica viene fatta tramite la curva Kaplan-Meier.

```{r}
data$EVENTO<-ifelse(is.na(data$`DATA DECESSO`), 0,1 )
data$EVENTO
data_1 <- mutate(data, all = EVENTO != "0")# La funzione mutate() del pacchetto dplyr serve per creare o modificare colonne di un dataframe. In questo caso, la funzione mutate() viene utilizzata per creare una nuova colonna chiamata "all", che assume valore TRUE se l'evento ("EVENTO") del paziente non è "0" e FALSE altrimenti.
```

```{r}
View(data)
```

**Modello di Kaplan-Meier**

Costruiamo la curva di sopravvivenza

```{r}
#Curva di sopravvivenza
curva_soprav <- survfit(Surv(ANNIOSSERV, all) ~ SOFAING_classe, data = data_1)
table_curva <- fortify(curva_soprav)
table_curva
```

```{r}
ggsurvplot(curva_soprav, title='Curva di sopravvivenza di Kaplan-Meier',
           risk.table = TRUE, xlab = "Tempo (Anni)", censor = F, 
           xlim = c(0,9), break.x.by = 1,
           palette = c("red", "steelblue"), # Imposta la palette di colori
           legend.title = "", # Imposta il titolo della legenda
           legend.labs = c('Sofa Alto','Sofa Basso'), # Imposta le etichette della legenda
           legend.labs.size = 14, # Imposta la dimensione delle etichette della legenda
           legend.position = "bottom", # Imposta la posizione della legenda
           legend.fontsize = 10, # Imposta la dimensione del font della legenda
           risk.table.col = "black", # Imposta il colore del testo della tabella
           risk.table.fontsize = 4, # Imposta la dimensione del font del testo della tabella
           risk.table.title = "Tabella dei rischi", # Imposta il titolo della tabella
           risk.table.height = 0.3, # Imposta l'altezza della tabella
           risk.table.width = 0.5) # Imposta la larghezza della tabella
```

Come si può facilmente osservare dal grafico è presente una riduzione della curva che fa riferimento a coloro che hanno un punteggio SOFA alto.
Ad esempio si nota come il 50% dei pazienti che avevano un punteggio SOFA alto all'inizio sono deceduti entro un anno, invece i pazienti con un punteggio relativamente basso si riducono del 10% circa.
Bisogna tener conto che l'affidabilità dei risultati deve tenere in considerazione la bassa numerosità del campione di riferimento e del periodo temporale preso in considerazione, è deducibile però che in linea di massima il risultato con un maggior numero di osservazioni sarebbe simile.

**Modello di Cox**

L'obiettivo dell'analisi è valutare l'associazione tra la variabile indipendente SOFA e la sopravvivenza dei pazienti.

Il modello di Cox è un modello di regressione utilizzato per analizzare la sopravvivenza in base a un insieme di variabili esplicative, è un modello semiparametrico in quanto assume solo una distribuzione per il tempo di sopravvivenza, ma non fa alcuna ipotesi sulla forma funzionale della relazione.
Dapprima utilizziamo il modello tenendo in considerazione la variabile di classificazione SOFA.

```{r}
# Esegue il modello di Cox
cox_SOFA <- coxph(Surv(ANNIOSSERV, all) ~ SOFAING_classe, data = data_1)

# Stampa i risultati
summary(cox_SOFA)
```

Il risultato più importante da notare è il p-value del test di Wald, pari a 0.001, che indica che la variabile indipendente SOFA è significativamente associata alla sopravvivenza dei pazienti. Inoltre, il coefficiente di regressione per la classe "sofa_basso" è -2.1358, il che significa che i pazienti con un punteggio SOFA basso hanno un tasso di rischio di mortalità significativamente inferiore rispetto a quelli con un punteggio SOFA alto.

Il valore di concordanza è pari a 0.768, il che indica un buon adattamento del modello ai dati. In generale, questi risultati suggeriscono che il punteggio SOFA può essere un fattore importante nella prognosi dei pazienti e può essere utilizzato come indicatore di gravità della malattia.

Ora utilzziamo il modello tenendo in considerazione anche le altre variabili.

```{r}
cox_GEN <- coxph(Surv(ANNIOSSERV,all)~SOFAING_classe+AGE_classi+BMI_classi+CCSCORE_classe+MMSE_classe+SEX,data = data_1)
summary(cox_GEN)
```

L'output mostra che diverse variabili predittive sono statisticamente significative nella previsione della variabile di outcome.
Ad esempio le variabili SOFA e MMSE, rispettivamente, con un punteggio basso e lieve/moderato  hanno valori p inferiori a 0,05, indicando che sono predittori significativi dell'outcome al livello 0,05. 

# Conclusions

In sintesi, il presente progetto ha riguardato un'analisi di dati complessi, caratterizzati da una serie di problemi quali la presenza di dati mancanti, errori di digitazione, valori anomali e una grande quantità di variabili. Attraverso un'accurata fase di pulizia dei dati e di pre-processing, siamo riusciti a rimuovere tali problemi e ad ottenere un dataset pulito e ben strutturato, pronto per l'analisi.

Successivamente, abbiamo condotto un'analisi esplorativa dei dati per comprendere meglio la distribuzione e la relazione tra le variabili. Questa fase ha permesso di individuare alcune variabili che sembrano influenzare la sopravvivenza dei soggetti in esame.

Infine, abbiamo applicato un'analisi di sopravvivenza per valutare l'effetto di queste variabili sulla sopravvivenza dei soggetti. I risultati hanno mostrato che alcune variabili sono fortemente correlate con la sopravvivenza e possono essere utilizzate come predittori per identificare i soggetti a maggior rischio.
